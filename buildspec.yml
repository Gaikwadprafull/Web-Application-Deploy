version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "Installing AWS CLI..."
      - pip install --upgrade awscli
      - aws --version

  build:
    commands:
      - echo "Looking for EC2 with tag Name=dev-AppServer..."
      - |
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=dev-AppServer" \
          --query "Reservations[*].Instances[*].InstanceId" \
          --output text --region ap-south-1)
        echo "Instance ID found: $INSTANCE_ID"
        if [ -z "$INSTANCE_ID" ]; then
          echo "❌ ERROR: No instance found"
          exit 1
        fi
        echo "✅ Instance: $INSTANCE_ID"
        aws ssm send-command \
          --document-name "AWS-RunShellScript" \
          --instance-ids "$INSTANCE_ID" \
          --comment "Triggered from CodeBuild" \
          --parameters '{"commands":["cd /home/ec2-user/myapp","git pull origin dev","chmod +x deploy.sh","./deploy.sh"]}' \
          --region ap-south-1

artifacts:
  files:
    - '**/*'
